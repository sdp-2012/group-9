package simulator;

import java.awt.Graphics2D;
import java.awt.event.KeyEvent;
import java.awt.event.KeyListener;
import java.awt.event.MouseEvent;
import java.awt.event.MouseListener;
import java.awt.event.MouseMotionListener;
import java.awt.event.WindowEvent;
import java.awt.event.WindowListener;

import javax.swing.JButton;

import org.jbox2d.common.Vec2;

import sdp.ControlPanel;
import sdp.DefendPenaltyStrategy;
import sdp.FriendlyStrategy;
import sdp.Gui;
import sdp.ImageViewer;
import sdp.NxtGui;
import sdp.PcServer;
import sdp.PenaltyKickStrategy;
import sdp.RobotInterface;
import sdp.RobotState;
import sdp.ControlPanel.ButtonCallback;
import sdp.Vector2;

public class SimGui implements Gui {
	private PcServer        server;
	private final SimWorld  world;
	private ControlPanel    generalPanel;
	private ImageViewer     viewer;
	
	public RobotState.Team getUserControlledTeam() {
		RobotState.Team t = server.getControl().getRobotState().getTeam();
		if( t == RobotState.Team.YELLOW )
			return RobotState.Team.BLUE;
		else
			return RobotState.Team.YELLOW;
	}
	
	public SimGui( PcServer iserver, SimWorld _world ) {
		this.server = iserver;
		this.world = _world;
		this.generalPanel = new ControlPanel();
		this.viewer       = new ImageViewer();
		
		generalPanel.setTitle("General");
		
		generalPanel.addButton( "Shutdown", new ControlPanel.ButtonCallback() {
			public void buttonClicked(JButton button) {
				shutdown();
			}
		});
		
		generalPanel.addButton( "Pause", new ControlPanel.ButtonCallback() {
			public void buttonClicked(JButton button) {
				world.setPaused(!world.isPaused());
				
				// Change the text to reflect the action it will do.
				button.setText(world.isPaused() ? "Resume" : "Pause");
			}
		});
		
		generalPanel.addButton( "Reset Simulation", new ControlPanel.ButtonCallback() {
			public void buttonClicked(JButton button) {
				world.reset();
				
			}
		});
		
		generalPanel.addButton( "Remove Strategy", new ControlPanel.ButtonCallback() {
			public void buttonClicked( JButton button ) {
				server.setStrategy( null );
			}
		});
		
		generalPanel.addButton( "Defend Penalty", new ControlPanel.ButtonCallback() {			
			@Override public void buttonClicked(JButton button) {
				server.setStrategy( new DefendPenaltyStrategy( server ) );
				server.enableStrategy();
			}
		});
		
		generalPanel.addButton( "Penalty Kick", new ControlPanel.ButtonCallback() {			
			@Override public void buttonClicked(JButton button) {
				server.setStrategy( new PenaltyKickStrategy( server ) );
				server.enableStrategy();
			}
		});
		
		generalPanel.addButton( "Normal Match", new ControlPanel.ButtonCallback() {			
			@Override public void buttonClicked(JButton button) {
				server.setStrategy( new FriendlyStrategy( server, Math.signum( server.getControl().getRobotState().getPosition().getX() ) ) );
				server.enableStrategy();
			}
		});
		
		vis.getViewer().getCanvas().addMouseListener( new MouseListener() {
			@Override public void mouseReleased(MouseEvent arg0) {}
			@Override public void mousePressed(MouseEvent arg0) {}
			@Override public void mouseExited(MouseEvent arg0) {}
			@Override public void mouseEntered(MouseEvent arg0) {}
			@Override public void mouseClicked(MouseEvent e) {
				Vector2 v = world.getScreenProjection().unprojectPosition( new Vector2( e.getX(), e.getY() ) );
				server.getControl().setGoalPosition( v ); 
				server.getControl().setStationary( false );
				server.getControl().setCurrentSpeed( 1.0 );
				server.getControl().setGoBackwards( false );
				server.getControl().setStopAtGoal( true );
			}
		});
		
		WindowListener winListener = new WindowListener() {
			@Override public void windowClosed(WindowEvent arg0) {}
			@Override public void windowActivated(WindowEvent arg0) {}
			@Override public void windowOpened(WindowEvent arg0) {}
			@Override public void windowIconified(WindowEvent arg0) {}
			@Override public void windowDeiconified(WindowEvent arg0) {}
			@Override public void windowDeactivated(WindowEvent arg0) {}
			@Override public void windowClosing(WindowEvent arg0) {
				shutdown();
			}
		};
		
		generalPanel.addWindowListener( winListener );
		viewer.addWindowListener( winListener );
		generalPanel.pack();
		
		UserInputListener uil = new UserInputListener(); 
		viewer.getCanvas().addMouseListener( uil );
		viewer.getCanvas().addMouseMotionListener( uil );
		viewer.getCanvas().addKeyListener( uil );
	}
	
	private class UserInputListener implements KeyListener, MouseListener, MouseMotionListener {
		private boolean mouseFix;
		
		void handleMovement( KeyEvent e, float d ) {
			RobotInterface intf = world.getRobotInterface( getUserControlledTeam() );
			Vector2 ws = intf.getWheelSpeeds();
			if( e.getKeyCode() == KeyEvent.VK_UP ) {
				ws = ws.plus( new Vector2( d, d ) );
			} else if( e.getKeyCode() == KeyEvent.VK_DOWN ) {
				ws = ws.minus( new Vector2( d, d ) );
			} else if( e.getKeyCode() == KeyEvent.VK_LEFT ) {
				ws = ws.plus( new Vector2( -d, d ) );
			} else if( e.getKeyCode() == KeyEvent.VK_RIGHT) {
				ws = ws.plus( new Vector2( d, -d ) );
			} else if( e.getKeyCode() == KeyEvent.VK_SPACE) {
				intf.kick();			
			} else if ( e.getKeyCode() == KeyEvent.VK_CONTROL){
				if(d>0) mouseFix = true; else mouseFix = false;
			}
			intf.setWheelSpeeds( ws );
		}
		
		@Override
		public void keyPressed(KeyEvent e) {
			handleMovement( e, 1.0f );
		}

		@Override
		public void keyReleased(KeyEvent e) {
			handleMovement( e, -1.0f );
		}
		
		@Override
		public void mouseDragged( MouseEvent e ) {
			world.dragMouseTarget( e.getX(), e.getY() );
		}
		
		@Override
		public void mousePressed( MouseEvent e ) {
			world.findMouseTarget( e.getX(), e.getY() );
		}
		
		@Override
		public void mouseReleased(MouseEvent arg0) {
			world.removeMouseTarget();
		}
		
		public boolean isRotationFixed() {
			return mouseFix;
		}

		@Override public void keyTyped(KeyEvent e)          {}
		@Override public void mouseMoved(MouseEvent arg0)   {}
		@Override public void mouseClicked(MouseEvent arg0) {}
		@Override public void mouseEntered(MouseEvent arg0) {}
		@Override public void mouseExited(MouseEvent arg0)  {}
	}
	
	private void shutdown() {
		server.shutdown();
	}
	
	public ControlPanel getStrategyPanel() {
		return generalPanel;
	}
	
	public ImageViewer getImageViewer() {
		return viewer;
	}

	@Override
	public void update() {
		viewer.showImage( world.getImage() );
	}

	@Override
	public void dispose() {
		generalPanel.dispose();
		viewer.dispose();
		world.dispose();
	}
}
